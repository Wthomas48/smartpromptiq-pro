generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Used for migrations (bypasses pooler)
}

model User {
  id        String  @id @default(cuid())
  email     String  @unique
  username  String? @unique
  password  String
  firstName String?
  lastName  String?
  avatar    String?
  role      String  @default("USER")

  // Subscription and billing
  subscriptionTier    String    @default("free") // free, starter, pro, business, enterprise
  subscriptionStatus  String    @default("active") // active, canceled, past_due, incomplete
  subscriptionEndDate DateTime?
  billingCycle        String    @default("monthly") // monthly, yearly

  // Stripe integration
  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique

  // Token management
  tokenBalance    Int @default(5) // Current token balance
  tokensPurchased Int @default(0) // Lifetime tokens purchased
  tokensUsed      Int @default(0) // Lifetime tokens used

  // Legacy fields (for backward compatibility)
  plan             String @default("FREE")
  generationsUsed  Int    @default(0)
  generationsLimit Int    @default(10)

  // Usage tracking
  monthlyTokensUsed Int       @default(0) // Resets monthly for subscription users
  monthlyResetDate  DateTime  @default(now())
  lastTokenPurchase DateTime?

  // Account status
  emailVerified    Boolean @default(false)
  isActive         Boolean @default(true)
  suspensionReason String?

  // Discord integration
  discordId       String? @unique
  discordUsername String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  lastLogin DateTime?

  teams                  TeamMember[]
  projects               Project[]
  generations            Generation[]
  analytics              Analytics[]
  templates              Template[]
  subscriptions          Subscription[]
  tokenTransactions      TokenTransaction[]
  tokenPurchases         TokenPurchase[]
  usageLogs              UsageLog[]
  prompts                Prompt[]
  feedback               Feedback[]
  customCategoryRequests CustomCategoryRequest[]
  notifications          Notification[]
  enrollments            Enrollment[]
  lessonProgress         LessonProgress[]
  certificates           Certificate[]
  courseReviews          CourseReview[]
  academySubscription    AcademySubscription?
  agents                 Agent[]
  apiKeys                ApiKey[]
  documents              Document[]

  @@map("users")
}

model Team {
  id          String  @id @default(cuid())
  name        String
  description String?
  maxMembers  Int     @default(5)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members  TeamMember[]
  projects Project[]

  @@map("teams")
}

model TeamMember {
  id     String @id @default(cuid())
  userId String
  teamId String
  role   String @default("MEMBER")

  joinedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@map("team_members")
}

model Project {
  id          String  @id @default(cuid())
  title       String
  description String?
  category    String
  status      String  @default("ACTIVE")

  settings String?
  metadata String?

  userId String
  teamId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  team        Team?        @relation(fields: [teamId], references: [id], onDelete: SetNull)
  generations Generation[]

  @@map("projects")
}

model Generation {
  id        String @id @default(cuid())
  projectId String
  userId    String

  prompt     String
  response   String
  model      String
  category   String
  tokenCount Int?
  cost       Float?
  quality    Int?
  metadata   String?

  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("generations")
}

model Template {
  id          String  @id @default(cuid())
  title       String
  description String?
  category    String
  content     String // Renamed from 'prompt' to match frontend
  tags        String? // Tags as comma-separated string
  isPublic    Boolean @default(false)

  usageCount Int    @default(0)
  rating     Float?

  userId String
  teamId String? // Added for team templates

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("templates")
}

model Analytics {
  id     String @id @default(cuid())
  userId String

  event    String
  category String
  value    Float?
  metadata String?

  timestamp DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("analytics")
}

// New models for token-based pricing system

model Subscription {
  id     String @id @default(cuid())
  userId String

  // Subscription details
  tier         String // free, starter, pro, business, enterprise
  status       String // active, canceled, past_due, incomplete, trialing
  billingCycle String // monthly, yearly

  // Pricing information (in cents)
  priceInCents     Int
  tokensPerMonth   Int // -1 for unlimited
  maxTokenRollover Int // -1 for unlimited

  // Stripe integration
  stripeSubscriptionId String? @unique
  stripePriceId        String?

  // Billing dates
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?

  // Trial information
  trialStart DateTime?
  trialEnd   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model TokenTransaction {
  id     String @id @default(cuid())
  userId String

  // Transaction details
  type          String // purchase, usage, rollover, expiration, refund, bonus
  tokens        Int // Positive for credits, negative for debits
  balanceBefore Int // Token balance before transaction
  balanceAfter  Int // Token balance after transaction

  // Cost tracking (in cents)
  costInCents Int? // For purchases and usage cost tracking

  // Purchase information
  packageType           String? // small, medium, large, bulk, subscription
  stripePaymentIntentId String?

  // Usage information
  promptComplexity String? // simple, standard, complex, custom
  model            String? // gpt3_5_turbo, gpt4, claude_sonnet, etc.
  category         String? // Category of prompt generated

  // Token expiration
  expiresAt DateTime? // For purchased tokens (90 days)
  isExpired Boolean   @default(false)

  // Metadata
  description String? // Human readable description
  metadata    String? // JSON metadata

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, type])
  @@index([expiresAt])
  @@map("token_transactions")
}

// Token Purchase record for idempotency and audit trail
model TokenPurchase {
  id     String @id @default(cuid())
  userId String

  // Purchase details
  tokenCount    Int    // Number of tokens purchased
  amountInCents Int    // Amount paid in cents
  packageKey    String // small, medium, large, bulk

  // Stripe integration - unique to prevent double-crediting
  stripePaymentIntentId String @unique

  // Status
  status String @default("completed") // pending, completed, refunded, failed

  // Metadata
  expiresAt DateTime? // Token expiration date (90 days from purchase)

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripePaymentIntentId])
  @@index([createdAt])
  @@map("token_purchases")
}

// Stripe Webhook Event tracking for idempotency
// Prevents duplicate processing when Stripe retries webhooks
model WebhookEvent {
  id            String   @id // Stripe event ID (evt_xxx)
  type          String   // Event type (e.g., customer.subscription.updated)
  processed     Boolean  @default(true)
  processedAt   DateTime @default(now())

  // Optional: store payload hash for debugging
  payloadHash   String?

  // Error tracking for failed processing
  errorMessage  String?
  retryCount    Int      @default(0)

  createdAt     DateTime @default(now())

  @@index([type])
  @@index([createdAt])
  @@index([processed])
  @@map("webhook_events")
}

model UsageLog {
  id     String @id @default(cuid())
  userId String

  // Request details
  endpoint String? // /api/prompts/generate, /api/prompts/refine, etc.
  method   String? // GET, POST, PUT, DELETE
  action   String? // voice:generate, music:generate, etc.

  // Usage metrics
  tokensConsumed   Int     @default(0)
  tokensUsed       Int     @default(0) // Alias for cost tracking
  promptComplexity String? // simple, standard, complex, custom
  model            String? // AI model used
  category         String? // Prompt category
  provider         String? // openai, elevenlabs, suno, etc.

  // Performance metrics
  responseTime Int? // Response time in milliseconds
  success      Boolean @default(true)
  errorCode    String? // Error code if failed

  // Cost tracking
  costInCents   Int     @default(0)
  cost          Float   @default(0) // Actual API cost in dollars
  marginInCents Int     @default(0) // Revenue - Cost

  // Request metadata
  userAgent String?
  ipAddress String?
  metadata  String? // JSON string for additional data

  // Rate limiting
  rateLimitHit  Boolean @default(false)
  rateLimitType String? // hourly, daily, api_minute

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, endpoint])
  @@index([createdAt])
  @@index([provider, createdAt])
  @@index([action, createdAt])
  @@map("usage_logs")
}

model Prompt {
  id         String  @id @default(cuid())
  title      String
  content    String
  category   String
  isFavorite Boolean @default(false)

  // Questionnaire data and customization
  questionnaire String? // JSON of questionnaire responses
  customization String? // JSON of customization settings

  // Usage tracking
  usageCount Int       @default(0)
  lastUsed   DateTime?

  userId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, category])
  @@index([userId, isFavorite])
  @@map("prompts")
}

model Feedback {
  id        String  @id @default(cuid())
  rating    Int // 1-5 star rating
  email     String? // Optional email for follow-up
  feedback  String? // Optional text feedback
  page      String? // Page where feedback was submitted
  userAgent String? // Browser/device info

  userId String

  submittedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([rating])
  @@index([submittedAt])
  @@map("feedback")
}

model CustomCategoryRequest {
  id             String  @id @default(cuid())
  categoryName   String
  description    String
  industryType   String?
  useCase        String?
  targetAudience String?
  priority       String  @default("medium") // low, medium, high, urgent

  // Contact info
  email       String
  companyName String?
  phone       String?

  // Status tracking
  status        String    @default("pending") // pending, reviewing, approved, in_development, completed, rejected
  submittedAt   DateTime  @default(now())
  reviewedAt    DateTime?
  implementedAt DateTime?

  // Admin fields
  reviewedBy String? // Admin user ID
  adminNotes String?

  userId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([submittedAt])
  @@map("custom_category_requests")
}

model Notification {
  id      String  @id @default(cuid())
  type    String // custom_category_request, custom_category_update, system_alert, etc.
  title   String
  message String
  data    String? // JSON data for additional context

  userId String? // null for admin notifications
  isRead Boolean @default(false)

  createdAt DateTime  @default(now())
  readAt    DateTime?

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================
// SMARTPROMPTIQ ACADEMY MODELS
// ============================================

model Course {
  id          String @id @default(cuid())
  title       String
  description String
  slug        String @unique
  category    String // prompt-engineering, devops, design, trading, finance
  difficulty  String // beginner, intermediate, advanced
  duration    Int // in minutes

  // Access control
  accessTier String // free, smartpromptiq_included, pro, certification
  priceUSD   Int    @default(0) // price in cents (0 for free)

  // Content
  thumbnailUrl String?
  videoUrl     String? // intro video
  syllabus     String? // JSON array of topics

  // Metadata
  isPublished Boolean @default(false)
  order       Int     @default(0)
  instructor  String?
  tags        String? // comma-separated

  // Stats
  enrollmentCount Int    @default(0)
  averageRating   Float?
  reviewCount     Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lessons     Lesson[]
  enrollments Enrollment[]
  reviews     CourseReview[]

  @@index([accessTier])
  @@index([category])
  @@index([isPublished])
  @@map("academy_courses")
}

model Lesson {
  id          String  @id @default(cuid())
  courseId    String
  title       String
  description String?

  // Content
  content  String // Rich text/markdown
  videoUrl String?
  duration Int // in minutes
  order    Int

  // Resources
  downloadUrl        String? // PDF, templates, etc
  codeSnippet        String? // Example code
  quizData           String? // JSON quiz questions
  exerciseData       String? // JSON hands-on exercise
  playgroundExamples String? // JSON playground examples

  // Access
  isPublished Boolean @default(false)
  isFree      Boolean @default(false) // Preview lesson

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  course   Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress LessonProgress[]

  @@index([courseId])
  @@index([isPublished])
  @@map("academy_lessons")
}

model Enrollment {
  id       String @id @default(cuid())
  userId   String
  courseId String

  // Enrollment type
  enrollmentType String // free, smartpromptiq_included, purchased, pro_subscription, certification

  // Payment (if applicable)
  paidAmount Int? // in cents
  paymentId  String? // Stripe payment intent ID

  // Status
  status   String @default("active") // active, completed, dropped, expired
  progress Float  @default(0) // percentage (0-100)

  // Timestamps
  enrolledAt     DateTime  @default(now())
  completedAt    DateTime?
  expiresAt      DateTime? // for time-limited access
  lastAccessedAt DateTime?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@map("academy_enrollments")
}

model LessonProgress {
  id       String @id @default(cuid())
  userId   String
  lessonId String

  // Progress tracking
  completed    Boolean @default(false)
  timeSpent    Int     @default(0) // seconds
  lastPosition Int? // for video progress (seconds)

  // Quiz/assessment
  quizScore    Int? // percentage
  quizAttempts Int  @default(0)

  // Notes
  userNotes String?

  // Rating & Feedback
  rating   Int? // 1-5 stars
  feedback String? // Text feedback from user

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@map("academy_lesson_progress")
}

model Certificate {
  id       String  @id @default(cuid())
  userId   String
  courseId String? // null for general certifications

  // Certificate details
  certificateType String // course_completion, certification_exam, specialization
  certificateUrl  String // URL to PDF certificate
  certificateCode String @unique // Verification code

  // Metadata
  title       String // e.g., "Certified Prompt Engineer"
  description String?
  skills      String? // JSON array of skills

  // Validity
  issuedAt  DateTime  @default(now())
  expiresAt DateTime? // for time-limited certifications
  isRevoked Boolean   @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([certificateCode])
  @@map("academy_certificates")
}

model CourseReview {
  id       String @id @default(cuid())
  userId   String
  courseId String

  // Review content
  rating     Int // 1-5 stars
  reviewText String?

  // Metadata
  isVerifiedPurchase Boolean @default(false)
  wasHelpful         Int     @default(0) // upvote count

  // Status
  isPublished Boolean @default(true)
  isFlagged   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([rating])
  @@map("academy_course_reviews")
}

model AcademySubscription {
  id     String @id @default(cuid())
  userId String @unique

  // Subscription tier: academy_basic, academy_pro, all_access
  tier         String @default("free")
  status       String @default("active") // active, canceled, past_due, expired
  billingCycle String @default("monthly") // monthly, yearly

  // Pricing (in cents)
  priceInCents Int @default(0)

  // Stripe integration
  stripeSubscriptionId String? @unique
  stripePriceId        String?

  // Billing dates
  currentPeriodStart DateTime @default(now())
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean  @default(false)

  // Trial
  trialStart DateTime?
  trialEnd   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("academy_subscriptions")
}

model LearningAnalytics {
  id       String  @id @default(cuid())
  userId   String
  courseId String?

  // Time tracking
  date      DateTime @default(now())
  timeSpent Int // seconds

  // Activity
  lessonsCompleted Int    @default(0)
  quizzesCompleted Int    @default(0)
  averageQuizScore Float?

  // Engagement
  loginCount Int @default(0)
  streakDays Int @default(0)

  // XP/Gamification
  xpEarned Int @default(0)

  @@index([userId])
  @@index([date])
  @@map("academy_learning_analytics")
}

// ============================================
// BUILDERIQ - APP CREATION PLATFORM
// ============================================

model BuilderIQTemplate {
  id          String @id @default(cuid())
  title       String
  description String
  slug        String @unique

  // Categorization
  industry    String // healthcare, finance, ecommerce, education, legal, realestate, entertainment, automotive, travel, fitness, restaurant, nonprofit
  category    String // crm, inventory, booking, analytics, support, marketplace, portal, management
  subcategory String? // more specific categorization

  // Template content
  promptContent    String // The actual master prompt
  blueprint        String? // JSON: structured blueprint data
  features         String? // JSON: array of features included
  techStack        String? // JSON: recommended tech stack
  userActions      String? // JSON: possible user actions
  compliance       String? // JSON: compliance requirements
  monetization     String? // JSON: monetization strategies

  // Metadata
  complexity    String @default("medium") // simple, medium, complex, enterprise
  estimatedTime String? // "2-4 weeks", "1-2 months", etc.
  targetUsers   String? // JSON: array of target user personas
  designStyle   String? // minimal, professional, playful, corporate, spiritual, futuristic
  colorScheme   String? // JSON: color palette

  // Stats & Discovery
  usageCount  Int     @default(0)
  rating      Float?
  reviewCount Int     @default(0)
  isFeatured  Boolean @default(false)
  isPublished Boolean @default(true)
  order       Int     @default(0)

  // AI Generation flags
  includesAuth      Boolean @default(true)
  includesPayments  Boolean @default(false)
  includesAI        Boolean @default(false)
  includesAnalytics Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  savedByUsers BuilderIQSavedTemplate[]

  @@index([industry])
  @@index([category])
  @@index([complexity])
  @@index([isPublished])
  @@index([isFeatured])
  @@map("builderiq_templates")
}

model BuilderIQQuestionnaire {
  id          String @id @default(cuid())
  title       String
  description String?

  // Questionnaire type
  industry String? // null = universal, or specific industry
  category String? // null = universal, or specific category

  // Questions structure (JSON)
  questions String // JSON: array of question objects with branching logic

  // Metadata
  isActive    Boolean @default(true)
  order       Int     @default(0)
  version     Int     @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([industry])
  @@index([category])
  @@index([isActive])
  @@map("builderiq_questionnaires")
}

model BuilderIQSession {
  id     String @id @default(cuid())
  userId String

  // Session data
  sessionType  String // questionnaire, template_customization, story_mode, voice
  status       String @default("in_progress") // in_progress, completed, abandoned

  // Input data
  responses       String? // JSON: questionnaire responses
  storyInput      String? // Natural language input from story mode
  voiceTranscript String? // Voice input transcript
  selectedTemplate String? // Template ID if started from template

  // Generated output
  generatedBlueprint String? // JSON: the final blueprint
  generatedPrompt    String? // The generated master prompt
  appName            String?
  appDescription     String?

  // User persona data
  userPersonas String? // JSON: generated user personas

  // Metadata
  industry    String?
  category    String?
  complexity  String?
  designStyle String?
  colorScheme String?

  // Collaboration
  collaborators String? // JSON: array of user IDs
  isShared      Boolean @default(false)
  shareCode     String? @unique

  // Voice/audio features
  voiceEnabled   Boolean @default(false)
  lastVoiceInput DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([userId])
  @@index([status])
  @@index([industry])
  @@index([shareCode])
  @@map("builderiq_sessions")
}

model BuilderIQSavedTemplate {
  id         String @id @default(cuid())
  userId     String
  templateId String

  // Customizations
  customizations String? // JSON: user's customizations to the template
  notes          String?
  isFavorite     Boolean @default(false)

  createdAt DateTime @default(now())

  template BuilderIQTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([userId, templateId])
  @@index([userId])
  @@map("builderiq_saved_templates")
}

model BuilderIQGeneratedApp {
  id     String @id @default(cuid())
  userId String

  // App details
  name        String
  description String?
  industry    String
  category    String

  // Generated content
  masterPrompt     String // The complete generated prompt
  blueprint        String // JSON: structured blueprint
  features         String // JSON: feature list
  techStack        String? // JSON: tech recommendations
  userPersonas     String? // JSON: user personas
  compliance       String? // JSON: compliance requirements
  monetization     String? // JSON: monetization strategy
  marketingCopy    String? // JSON: generated marketing materials

  // Design
  designStyle String?
  colorScheme String?
  logoSuggestions String? // JSON: logo/brand suggestions

  // Session reference
  sessionId String?

  // Stats
  exportCount Int @default(0)
  lastExportedAt DateTime?

  // Status
  status String @default("draft") // draft, finalized, exported, in_development

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([industry])
  @@index([status])
  @@map("builderiq_generated_apps")
}

model BuilderIQIndustry {
  id          String @id @default(cuid())
  name        String @unique
  displayName String
  description String?
  icon        String? // emoji or icon name
  color       String? // hex color for UI

  // Industry-specific data
  commonFeatures    String? // JSON: common features in this industry
  complianceNeeds   String? // JSON: typical compliance requirements
  targetAudiences   String? // JSON: common target audiences
  trendingFeatures  String? // JSON: trending features in 2024-2025

  // Stats
  templateCount Int @default(0)
  popularity    Int @default(0)

  isActive Boolean @default(true)
  order    Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@map("builderiq_industries")
}

// ============================================
// REFERRAL SYSTEM
// ============================================

model ReferralCode {
  id     String @id @default(cuid())
  userId String @unique // Each user has one referral code

  // The unique referral code (e.g., "JOHN2024" or auto-generated)
  code String @unique

  // Customizable reward settings
  referrerRewardTokens Int @default(50) // Tokens the referrer gets
  refereeRewardTokens  Int @default(25) // Tokens the new user gets

  // Stats
  totalReferrals       Int @default(0)
  successfulReferrals  Int @default(0) // Referrals that converted to paid
  totalEarnings        Int @default(0) // Total tokens earned from referrals

  // Status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  referrals Referral[]

  @@index([code])
  @@index([userId])
  @@map("referral_codes")
}

model Referral {
  id             String @id @default(cuid())
  referralCodeId String
  referrerId     String // User who referred
  refereeId      String // User who was referred

  // Status tracking
  status String @default("pending") // pending, signed_up, converted, rewarded, expired

  // Reward tracking
  referrerRewarded   Boolean   @default(false)
  refereeRewarded    Boolean   @default(false)
  referrerRewardDate DateTime?
  refereeRewardDate  DateTime?

  // Token rewards given
  referrerTokensAwarded Int @default(0)
  refereeTokensAwarded  Int @default(0)

  // Conversion tracking
  signedUpAt  DateTime  @default(now())
  convertedAt DateTime? // When referee made first purchase/upgraded

  // Attribution
  referralSource String? // signup, landing_page, share_link, email
  utmCampaign    String?
  utmMedium      String?
  utmSource      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  referralCode ReferralCode @relation(fields: [referralCodeId], references: [id], onDelete: Cascade)

  @@unique([referrerId, refereeId]) // Can't refer same person twice
  @@index([referrerId])
  @@index([refereeId])
  @@index([status])
  @@index([referralCodeId])
  @@map("referrals")
}

model ReferralReward {
  id     String @id @default(cuid())
  userId String

  // Reward details
  type        String // referrer_signup, referrer_conversion, referee_welcome, milestone_bonus
  tokens      Int // Tokens awarded
  description String?

  // Source
  referralId String? // Link to the referral that triggered this

  // Status
  status    String   @default("credited") // credited, pending, expired, revoked
  creditedAt DateTime @default(now())

  // Milestone tracking
  milestoneType String? // first_referral, 5_referrals, 10_referrals, 25_referrals, 50_referrals, 100_referrals

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([status])
  @@map("referral_rewards")
}

// ============================================
// VOICE BUILDER SYSTEM
// ============================================

model VoiceProject {
  id     String @id @default(cuid())
  userId String

  // Project details
  title       String
  description String?
  category    String? // marketing, education, business, ecommerce, healthcare, entertainment, apps, personal

  // Script content
  script String // The text to be converted to voice

  // Voice configuration
  voiceId       String  // AI voice ID (nova, onyx, echo, etc.)
  voicePersona  String? // Celebrity-style persona name (Victoria Sterling, Marcus Vox, etc.)
  voiceStyle    String? // professional, friendly, energetic, calm, dramatic, storytelling
  voiceSettings String? // JSON: { rate, pitch, volume, stability, clarity }

  // Generated audio
  audioUrl      String? // URL/path to generated audio file
  audioFormat   String  @default("mp3") // mp3, wav, ogg
  audioDuration Int?    // Duration in seconds
  audioFileSize Int?    // File size in bytes

  // Source context (integration with other features)
  sourceType    String? // blueprint, lesson, prompt, standalone
  sourceId      String? // ID of the source (blueprint ID, lesson ID, etc.)
  sourceName    String? // Name of the source for reference

  // Token tracking
  tokensUsed   Int @default(0)
  charCount    Int @default(0)

  // Status
  status String @default("draft") // draft, generating, completed, failed, archived

  // Quality & feedback
  rating       Int? // 1-5 star rating
  feedbackNote String?

  // Sharing
  isPublic    Boolean @default(false)
  shareCode   String? @unique
  playCount   Int     @default(0)
  downloadCount Int   @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  generatedAt DateTime?

  @@index([userId])
  @@index([category])
  @@index([status])
  @@index([sourceType])
  @@index([shareCode])
  @@map("voice_projects")
}

model VoiceTemplate {
  id String @id @default(cuid())

  // Template details
  name        String
  description String?
  category    String // marketing, education, business, etc.

  // Script template with placeholders
  scriptTemplate String // Template with [placeholders] for customization
  placeholders   String? // JSON: array of placeholder definitions

  // Recommended settings
  recommendedVoice  String? // Recommended voice ID
  recommendedStyle  String? // Recommended style
  estimatedDuration Int?    // Estimated duration in seconds

  // Use case
  useCase     String? // app-pitch, product-demo, course-intro, etc.
  contentType String? // video-ad, podcast-intro, meditation, etc.

  // Stats
  usageCount Int   @default(0)
  rating     Float @default(0)

  // Status
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)
  order      Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([isActive])
  @@index([isFeatured])
  @@map("voice_templates")
}

model VoiceGeneration {
  id     String @id @default(cuid())
  userId String

  // Generation details
  text       String // Input text
  voiceId    String // Voice used
  style      String? // Style applied
  settings   String? // JSON: voice settings used

  // Output
  audioUrl     String? // Generated audio URL
  duration     Int?    // Duration in seconds
  format       String  @default("mp3")

  // Token & cost tracking
  charCount  Int @default(0)
  tokensUsed Int @default(0)
  cost       Float @default(0) // Cost in dollars for tracking

  // Source tracking (integration)
  sourceType String? // blueprint, lesson, prompt, voice-builder
  sourceId   String?

  // Status
  status String @default("completed") // pending, generating, completed, failed

  // Metadata
  category   String?
  projectId  String? // Link to voice project if part of one

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([status])
  @@index([sourceType])
  @@index([createdAt])
  @@map("voice_generations")
}

// ============================================
// AI MUSIC STUDIO SYSTEM
// ============================================

model MusicTrack {
  id     String @id @default(cuid())
  userId String

  // Track details
  name        String
  description String?
  prompt      String? // The prompt used to generate the track

  // Music properties
  genre       String // upbeat, calm, corporate, cinematic, electronic, lofi, hiphop, jazz, rock, etc.
  mood        String? // happy, sad, energetic, relaxed, dramatic, romantic, etc.
  style       String? // instrumental, vocal, mixed
  tempo       Int?    // BPM

  // Audio file
  audioUrl    String? // URL/path to audio file (could be blob URL for client-generated)
  audioFormat String  @default("wav") // wav, mp3, ogg
  duration    Int     @default(30) // Duration in seconds
  fileSize    Int?    // File size in bytes

  // Generation details
  generationType String @default("procedural") // procedural (Web Audio), ai_api (Suno/etc), uploaded
  generationParams String? // JSON: parameters used for generation

  // Song mode features
  withVocals Boolean @default(false)
  lyrics     String? // Lyrics if vocal track
  vocalStyle String? // female, male, rap, choir, etc.

  // Token/usage tracking
  tokensUsed Int @default(0)

  // Status
  status String @default("completed") // draft, generating, completed, failed

  // User engagement
  playCount     Int @default(0)
  downloadCount Int @default(0)
  isFavorite    Boolean @default(false)
  rating        Int? // 1-5 stars

  // Sharing
  isPublic  Boolean @default(false)
  shareCode String? @unique

  // Integration with other features
  projectId  String? // Link to a project
  sourceType String? // voice-builder, song-mode, music-maker, mixer
  sourceId   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([genre])
  @@index([status])
  @@index([isFavorite])
  @@index([shareCode])
  @@map("music_tracks")
}

model MusicMix {
  id     String @id @default(cuid())
  userId String

  // Mix details
  name        String
  description String?

  // Tracks in the mix (JSON array of track IDs with settings)
  tracks String // JSON: [{ trackId, volume, pan, startTime, effects }]

  // Mix settings
  masterVolume Float   @default(1.0)
  ducking      Boolean @default(false) // Auto-duck music when voice plays
  fadeIn       Int?    // Fade in duration in ms
  fadeOut      Int?    // Fade out duration in ms

  // Voice overlay
  hasVoice     Boolean @default(false)
  voiceTrackId String? // Reference to a voice generation

  // Output
  outputUrl    String? // Final mixed audio URL
  outputFormat String  @default("wav")
  duration     Int?    // Total duration in seconds

  // Status
  status String @default("draft") // draft, mixing, completed, failed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@map("music_mixes")
}

model SongProject {
  id     String @id @default(cuid())
  userId String

  // Song details
  name        String
  description String?

  // Creation mode
  creationMode String // lyrics, voice, description (how the song was created)

  // Input content
  lyrics       String? // Written lyrics
  voiceInput   String? // URL to voice recording (humming/singing)
  promptDescription String? // Natural language description

  // Song properties
  genre     String // pop, rock, hiphop, country, electronic, jazz, etc.
  mood      String? // happy, sad, romantic, energetic, etc.
  style     String? // ballad, dance, acoustic, orchestral, etc.
  vocalStyle String? // female, male, duet, choir, rap, etc.
  tempo     Int?    // BPM

  // Generated output
  audioUrl    String? // Final song audio
  duration    Int?    // Duration in seconds
  format      String  @default("mp3")

  // Lyrics (if generated or refined)
  generatedLyrics String?

  // Token tracking
  tokensUsed Int @default(0)

  // Status
  status String @default("draft") // draft, generating, completed, failed

  // User engagement
  playCount     Int @default(0)
  downloadCount Int @default(0)
  isFavorite    Boolean @default(false)
  rating        Int?

  // Sharing
  isPublic  Boolean @default(false)
  shareCode String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([genre])
  @@index([status])
  @@index([isFavorite])
  @@map("song_projects")
}

// ═══════════════════════════════════════════════════════════════════════════════
// SUNO AI MUSIC BUILDER
// ═══════════════════════════════════════════════════════════════════════════════

model SunoSong {
  id     String @id @default(cuid())
  userId String

  // Song details
  title       String
  prompt      String  // The Suno-optimized prompt
  lyrics      String? // AI-generated or custom lyrics

  // Music configuration
  genre       String   // pop, rock, hip-hop, etc.
  mood        String   // happy, sad, energetic, etc.
  tempo       String   // slow, medium, fast, etc.
  vocals      String   // male, female, instrumental, etc.
  contentType String?  // youtube-intro, podcast-intro, full-song, etc.

  // Audio file
  audioUrl    String?  // URL to uploaded Suno audio
  audioFileId String?  // File storage ID if using cloud storage
  duration    Float?   // Duration in seconds

  // Status tracking
  status      String @default("prompt_ready") // prompt_ready, uploaded, mixed, exported

  // Usage stats
  playCount     Int @default(0)
  downloadCount Int @default(0)
  isFavorite    Boolean @default(false)

  // Mixing settings (when combined with intro/outro)
  introTrackId  String?
  outroTrackId  String?
  mixedAudioUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([genre])
  @@index([status])
  @@map("suno_songs")
}

// ═══════════════════════════════════════════════════════════════════════════════
// EMBEDDABLE WIDGET SYSTEM - Agent Chat Platform
// ═══════════════════════════════════════════════════════════════════════════════

model Agent {
  id     String @id @default(cuid())
  userId String // Owner of the agent

  // Agent identity
  name        String
  slug        String  @unique // URL-friendly identifier (e.g., "grant-writer")
  description String?
  avatar      String? // URL to agent avatar image

  // AI configuration
  provider    String  @default("anthropic") // anthropic, openai
  model       String  @default("claude-3-haiku-20240307") // Model to use
  systemPrompt String // The agent's personality and instructions
  temperature Float   @default(0.7)
  maxTokens   Int     @default(1024)

  // Behavior settings
  welcomeMessage  String? // Initial message when chat opens
  suggestedQueries String? // JSON array of suggested questions
  allowedDomains  String? // JSON array of domains where widget can be embedded (null = any)

  // Voice settings (for voice-first)
  voiceEnabled    Boolean @default(false)
  voiceId         String? // ElevenLabs voice ID
  speechToText    Boolean @default(false)

  // Styling
  primaryColor    String  @default("#6366f1") // Brand color
  position        String  @default("bottom-right") // bottom-right, bottom-left
  theme           String  @default("light") // light, dark, auto

  // Access control
  isPublic        Boolean @default(false) // Listed in marketplace
  isActive        Boolean @default(true)

  // Usage limits
  dailyMessageLimit Int? // null = unlimited
  monthlyMessageLimit Int?

  // Stats
  totalConversations Int @default(0)
  totalMessages      Int @default(0)
  averageRating      Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user          User @relation(fields: [userId], references: [id], onDelete: Cascade)
  apiKeys       ApiKey[]
  conversations Conversation[]
  agentDocuments AgentDocument[]

  @@index([userId])
  @@index([slug])
  @@index([isPublic])
  @@index([isActive])
  @@map("agents")
}

model AgentDocument {
  id         String @id @default(cuid())
  agentId    String
  documentId String

  createdAt DateTime @default(now())

  agent    Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([agentId, documentId])
  @@index([agentId])
  @@index([documentId])
  @@map("agent_documents")
}

model ApiKey {
  id      String @id @default(cuid())
  userId  String // Owner
  agentId String // Associated agent

  // Key details
  name        String // Human-readable name (e.g., "Production Widget")
  keyHash     String @unique // Hashed API key (store hash, not plaintext)
  keyPrefix   String // First 8 chars for identification (e.g., "spiq_abc1")

  // Permissions
  permissions String @default("chat") // JSON array: ["chat", "history", "feedback"]

  // Rate limiting
  rateLimitPerMinute Int @default(60)
  rateLimitPerDay    Int @default(10000)

  // Domain restrictions (CORS)
  allowedOrigins String? // JSON array of allowed origins (null = any)

  // Status
  isActive    Boolean   @default(true)
  lastUsedAt  DateTime?
  usageCount  Int       @default(0)

  // Expiration
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([agentId])
  @@index([keyPrefix])
  @@index([isActive])
  @@map("api_keys")
}

model Conversation {
  id        String  @id @default(cuid())
  agentId   String
  sessionId String  // Client-generated session ID for anonymous users
  userId    String? // Optional: if user is authenticated

  // Metadata
  title       String? // Auto-generated from first message
  source      String  @default("widget") // widget, api, dashboard
  sourceUrl   String? // URL where widget was embedded
  userAgent   String?
  ipAddress   String?

  // Context (passed by embedding site)
  context     String? // JSON object with page context

  // Status
  status      String @default("active") // active, archived, flagged

  // Feedback
  rating      Int?    // 1-5 stars
  feedback    String? // User feedback text

  // Stats
  messageCount Int @default(0)
  tokenCount   Int @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastMessageAt DateTime?

  agent    Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([agentId])
  @@index([sessionId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("conversations")
}

model Message {
  id             String @id @default(cuid())
  conversationId String

  // Message content
  role    String // user, assistant, system
  content String

  // Token usage
  promptTokens     Int?
  completionTokens Int?
  totalTokens      Int?

  // Cost tracking
  costInCents Int?

  // Performance
  latencyMs Int? // Response time in milliseconds

  // Metadata
  metadata String? // JSON: tool calls, citations, etc.

  createdAt DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([role])
  @@index([createdAt])
  @@map("messages")
}

// ============================================
// RAG - DOCUMENT CHAT SYSTEM
// ============================================

model Document {
  id     String @id @default(cuid())
  userId String

  title       String
  fileName    String
  fileType    String  // pdf, txt, md, docx
  fileSize    Int     // bytes
  mimeType    String
  filePath    String  // Supabase Storage path

  status       String  @default("uploading") // uploading, processing, ready, failed
  errorMessage String?
  textContent  String? // Full extracted text
  chunkCount   Int     @default(0)
  totalTokens  Int     @default(0)

  chatCount  Int       @default(0)
  lastChatAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  chunks         DocumentChunk[]
  chats          DocumentChat[]
  agentDocuments AgentDocument[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("documents")
}

model DocumentChunk {
  id         String @id @default(cuid())
  documentId String

  content    String
  chunkIndex Int
  tokenCount Int

  embedding  String  // JSON array of floats (1536 dims)

  pageNumber Int?
  heading    String?

  createdAt DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([chunkIndex])
  @@map("document_chunks")
}

model DocumentChat {
  id         String @id @default(cuid())
  documentId String
  userId     String

  title    String?
  provider String  @default("openai")
  model    String  @default("gpt-4o")

  messageCount Int @default(0)
  tokenCount   Int @default(0)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastMessageAt DateTime?

  document Document              @relation(fields: [documentId], references: [id], onDelete: Cascade)
  messages DocumentChatMessage[]

  @@index([documentId])
  @@index([userId])
  @@index([createdAt])
  @@map("document_chats")
}

model DocumentChatMessage {
  id     String @id @default(cuid())
  chatId String

  role    String // user, assistant, system
  content String

  promptTokens     Int?
  completionTokens Int?
  totalTokens      Int?

  chunksUsed  String? // JSON array of chunk IDs
  costInCents Int?

  createdAt DateTime @default(now())

  chat DocumentChat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@index([createdAt])
  @@map("document_chat_messages")
}
